/**
 * Command Line Interpreter.
 *
 * https://github.com/chzager/cli
 *
 * @copyright (c) 2025 Christoph Zager
 * @license MIT
 */
class CommandLineInterpreter{static builtInCommands={clear:(e,...t)=>{switch(t?.[0]){case"--?":e.writeLn("Usage: clear").writeLn("Clear all output.");break;case void 0:e.body.replaceChildren();break;default:e.writeLn(`clear: Invalid argument: ${t[0]}`)}},help:(e,...t)=>{switch(t?.[0]){case"--?":e.writeLn("Usage: help").writeLn("Display a list of all available commands.");break;case void 0:e.writeLn("These are the available commands:"),e.writeLn(Array.from(e.commands.keys()).sort().map((e=>`\t${e}`)).join("\n")),e.writeLn("\nType `<command> --?` for help on a specific command.");break;default:e.writeLn(`help: Invalid argument: ${t[0]}`)}},history:(e,...t)=>{switch(t?.[0]){case"--?":e.writeLn("Usage: history [option]").writeLn("Display or manipulate the list of all that has been entered.").writeLn("Optional arguments to manipulate the history:").writeLn(["  \t--clean\tRemove duplicate entries and invalid commands","  \t--clear\tClean the entire history"].join("\n"));break;case"--clear":e.history=[],e.memorize("history",e.history);break;case"--clean":let i=Object.keys(CommandLineInterpreter.builtInCommands),r=Array.from(e.commands.keys()).filter((e=>!i.includes(e)));e.history=Array.from(new Set(e.history)).filter((e=>{let t=/^\S+/.exec(e)?.[0]??"";return r.includes(t)})),e.memorize("history",e.history),e.writeLn("** The history has been cleaned. **");break;case void 0:if(e.history.length>0)for(let t of e.history)e.writeLn(t);else e.writeLn("** The history is empty. **");break;default:e.writeLn(`history: Invalid argument: ${t[0]}`)}},printvars:(e,...t)=>{switch(t?.[0]){case"--?":e.writeLn("Usage: printvars").writeLn("Display all stored variables.");break;case void 0:if(e.variables.size>0){let t=Array.from(e.variables.entries());for(let[i,r]of t.sort(((e,t)=>e[0].localeCompare(t[0]))))e.writeLn(`${i}=${r}`)}else e.writeLn("** There are no variables defined. **");break;default:e.writeLn(`printvars: Invalid argument: ${t[0]}`)}}};id;body;commands;prompt;options;history;variables;constructor(e,t,i){const r=e=>{let t=e.target;switch(e.key){case"PageUp":this.body.scrollBy(0,0-(this.body.clientHeight-10));break;case"PageDown":this.body.scrollBy(0,this.body.clientHeight-10);break;case"ArrowUp":this.history.position>0&&this.history.length>0&&(this.history.position-=1,t.innerText=this.history[this.history.position],setTimeout((()=>{let e=document.createRange(),i=window.getSelection();i&&(e.setStart(t.childNodes[0],t.innerText.length),e.setEnd(t.childNodes[0],t.innerText.length),i.removeAllRanges(),i.addRange(e))}),10));break;case"ArrowDown":this.history.position<this.history.length&&(this.history.position+=1,t.innerText=this.history.position===this.history.length?"":this.history[this.history.position]);break;case"Escape":t.innerText="";break;case"Enter":let e=t.innerText;t.replaceWith(CommandLineInterpreter.createElement("span.input",e+"\n")),/\w/.test(e)&&(this.history.position=this.history[this.history.length-1]!==e?this.history.push(e.trim()):this.history.length,this.memorize("history",this.history)),this.eval(e.trim()).finally((()=>{this.receiveInput(this.prompt,r)}))}};if(this.prompt=i.prompt||"\nCLI> ",this.options={richtextEnabled:i.richtextEnabled??!0,tabString:" ".repeat(i.tabWidth||2)},this.id=i?.id||this.constructor.name,"custom"!==i.theme&&document.head.append(CommandLineInterpreter.createElement(`link[rel="stylesheet"][href="https://cdn.jsdelivr.net/gh/chzager/cli/themes/${i.theme||"default"}.css"]`)),this.history=[],this.variables=new Map,localStorage){let e=JSON.parse(localStorage.getItem(this.id)||"{}");this.history=e?.history??[],Object.entries(e?.variables??{}).map((([e,t])=>this.variables.set(e,t)))}this.history.position=this.history.length,this.commands=new Map;for(let t of[CommandLineInterpreter.builtInCommands,e])for(let[e,i]of Object.entries(t))"function"==typeof i&&this.commands.set(e,i);document.head.appendChild(CommandLineInterpreter.createElement("style",`#${this.constructor.name} * {${["background-color: transparent;","color: inherit;","font-family: inherit;","font-size: inherit;","padding: 0;","margin: 0;","border: none;","outline: none;","white-space: inherit;"].join("")}}`)),this.body=CommandLineInterpreter.createElement("div"),this.body.id=this.constructor.name,this.body.onclick=()=>{if(""===window.getSelection()?.toString()){let e=this.body.querySelector('.input[contenteditable="true"]');e instanceof HTMLElement&&e.focus()}},this.body.style.padding=i.padding||"0.75em",t instanceof HTMLElement||(t=document.body),t.appendChild(this.body),i?.motd&&this.writeLn(i.motd),this.eval(i?.startup??"").then((()=>{this.receiveInput(this.prompt,r)}))}eval(e){return new Promise((t=>{const i=e=>{this.writeLn(`[31m${e}`),console.error(e)},r=e=>new Promise((t=>{let r=!0,n=/^\s*(\S+)\s*=(.*)/.exec(e);if(n)if(/\W/.test(n[1]))this.writeLn(`Invalid token: ${/\W/.exec(n[1])?.[0]}`);else{let e=n[1],t=n[2].trim();t?this.variables.set(e,t):this.variables.delete(e),this.memorize("variables",Object.fromEntries(this.variables.entries()))}else{let n=/(\S+)(.*)/.exec(e);if(n){let e=n[1],s=this.commands.get(e);if("function"==typeof s){let e=[];for(let t of(n[2]??"").matchAll(/"([^"]*)"|\S+/g))e.push(t[1]||t[0]);e=e.map((e=>{if(!1===e.startsWith("-"))for(let t of e.matchAll(/\$(\w+)/g))e=e.replace(t[0],this.variables.get(t[1])??t[0]);return e}));try{let n=s(this,...e);n instanceof Promise&&(r=!1,n.catch(i).finally(t))}catch(e){i(e)}}else this.writeLn(`Unknown command: ${e}`)}}r&&t()})),n=()=>{let e=s.shift();e?r(e).finally(n):t()};let s=e.split(/\s*[;\n]+\s*/).filter((e=>!!e.trim()));n()}))}receiveInput(e,t){this.write(e);let i=CommandLineInterpreter.createElement('span.input[contenteditable="true"][spellcheck="false"][autocorrect="off"][autocapitalize="none"]');i.onkeydown=e=>{e.stopImmediatePropagation(),t(e)},setTimeout((()=>{this.body.appendChild(i),this.body.scrollTo(0,this.body.scrollHeight),i.focus()}),10)}memorize(e,t){if(localStorage){let i=JSON.parse(localStorage.getItem(this.id)||"{}");i[e]=t,localStorage.setItem(this.id,JSON.stringify(i))}}write(e){const t=e=>{let i=[],r=/((\*{1,2}|_{1,2}|`)([^\*\s].*?)\2)|((http)s?:\/\/\S+\b)|((\x1b\[)(3[0-7]|0)m(.+))/g;for(let n of e.matchAll(r)){let r,s,a=n[2]??n[5]??n[7],o=n[3]??n[4]??n[9],l=e.indexOf(o),h=o.length;if("["===a){let e="--cli-color-foreground";switch(n[8]){case"30":e="--cli-color-black";break;case"31":e="--cli-color-red";break;case"32":e="--cli-color-green";break;case"33":e="--cli-color-yellow";break;case"34":e="--cli-color-blue";break;case"35":e="--cli-color-magenta";break;case"36":e="--cli-color-cyan";break;case"37":e="--cli-color-white";break}r=`span[style="color:var(${e}"]`,s=t(o);let i=n[8].length+3;l-=i,h+=i}else if("http"===a)r=`a[href="${o}"][target="_blank"]`,s=[o];else{switch(a){case"**":case"__":r="b",s=t(o);break;case"*":case"_":r="i",s=t(o);break;case"`":r="code",s=[o];break}l-=a.length,h+=2*a.length}i.push(e.substring(0,l),CommandLineInterpreter.createElement(r,...s)),e=e.substring(l+h)}return i.push(e),i},i=e=>CommandLineInterpreter.createElement("table",...e.split("\n").map((e=>CommandLineInterpreter.createElement("tr",...e.split("\t").map((e=>{let i=CommandLineInterpreter.createElement("td",...t(e+this.options.tabString));return/^[\-\+]?\d+(\.\d*)?\s*$/.test(i.innerText)&&(i.style="text-align: right"),i}))))));return this.options.richtextEnabled?/\t/.test(e)?this.body.append(i(e.replace(/[\s\n]*$/g,""))):this.body.append(...t(e)):this.body.append(e.replace(/\x1b\[\d+m/g,"")),this.body.scrollTo(0,this.body.scrollHeight),this}writeLn(e){return this.write(e+"\n")}readKey(e,t){return new Promise((i=>{let r=[...e.map((e=>e.toLowerCase()))];this.receiveInput(t||e.join("/").toUpperCase()+"? ",(e=>{if(!1===/^f\d/i.test(e.key)&&(e.preventDefault(),r.includes(e.key.toLowerCase()))){let t=e.key;e.target.replaceWith(CommandLineInterpreter.createElement("span",t+"\n")),i(t.toUpperCase())}}))}))}readLn(e){return new Promise((t=>{this.receiveInput(e||"> ",(e=>{let i=e.target;switch(e.key){case"Escape":i.innerText="";break;case"Enter":i.replaceWith(CommandLineInterpreter.createElement("span.input",i.innerText+"\n")),t(i.innerText)}}))}))}readSecret(e){return new Promise((t=>{let i="";this.receiveInput(e||"> ",(e=>{switch(e.key){case"Enter":e.target.replaceWith(CommandLineInterpreter.createElement("span","\n")),t(i);break;case"Backspace":i=i.substring(0,i.length-1);break;default:1===e.key.length&&(e.preventDefault(),i+=e.key)}}))}))}static createElement(e,...t){let i=document.createElement(/^[a-z0-1]+/.exec(e)?.[0]||"div");for(let t of e.matchAll(/\[(.+?)=["'](.+?)["']\]/g))i.setAttribute(t[1],t[2]);for(let t of e.replaceAll(/\[.+\]/g,"").matchAll(/\.([^.[\s]+)/g))i.classList.add(t[1]);return i.append(...t),i}}
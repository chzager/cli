/**
 * Command Line Interpreter.
 *
 * https://github.com/chzager/cli
 *
 * @copyright (c) 2025 Christoph Zager
 * @license MIT
 */
class CommandLineInterpreter{static builtInCommands={clear:(e,...t)=>{switch(t?.[0]){case"--?":e.writeLn("Usage: clear").writeLn("Clear all output.");break;case void 0:e.body.replaceChildren();break;default:e.writeLn(`clear: Invalid argument: ${t[0]}`)}},help:(e,...t)=>{switch(t?.[0]){case"--?":e.writeLn("Usage: help").writeLn("Display a list of all available commands.");break;case void 0:e.writeLn("These are the available commands:"),e.writeLn(Array.from(e.commands.keys()).sort().map((e=>`\t${e}`)).join("\n")),e.writeLn("\nType `<command> --?` for help on a specific command.");break;default:e.writeLn(`help: Invalid argument: ${t[0]}`)}},history:(e,...t)=>{switch(t?.[0]){case"--?":e.writeLn("Usage: history [option]").writeLn("Display or manipulate the list of all that has been entered.").writeLn("Optional arguments to manipulate the history:").writeLn(["  \t--clean\tRemove duplicate entries and invalid commands","  \t--clear\tClean the entire history"].join("\n"));break;case"--clear":e.history=[],e.memorize("history",e.history);break;case"--clean":let r=Object.keys(CommandLineInterpreter.builtInCommands),i=Array.from(e.commands.keys()).filter((e=>!r.includes(e)));e.history=Array.from(new Set(e.history)).filter((e=>{let t=/^\S+/.exec(e)?.[0]??"";return i.includes(t)})),e.memorize("history",e.history),e.writeLn("** The history has been cleaned. **");break;case void 0:if(e.history.length>0)for(let t of e.history)e.writeLn(t);else e.writeLn("** The history is empty. **");break;default:e.writeLn(`history: Invalid argument: ${t[0]}`)}},printvars:(e,...t)=>{switch(t?.[0]){case"--?":e.writeLn("Usage: printvars").writeLn("Display all stored variables.");break;case void 0:if(e.variables.size>0){let t=Array.from(e.variables.entries());for(let[r,i]of t.sort(((e,t)=>e[0].localeCompare(t[0]))))e.writeLn(`${r}=${i}`)}else e.writeLn("** There are no variables defined. **");break;default:e.writeLn(`printvars: Invalid argument: ${t[0]}`)}}};id;body;commands;prompt;options;history;variables;constructor(e,t,r){const i=e=>{let t=e.target;switch(e.key){case"PageUp":this.body.scrollBy(0,0-(this.body.clientHeight-10));break;case"PageDown":this.body.scrollBy(0,this.body.clientHeight-10);break;case"ArrowUp":n>0&&this.history.length>0&&(n-=1,t.innerText=this.history[n],setTimeout((()=>{let e=document.createRange(),r=window.getSelection();r&&(e.setStart(t.childNodes[0],t.innerText.length),e.setEnd(t.childNodes[0],t.innerText.length),r.removeAllRanges(),r.addRange(e))}),10));break;case"ArrowDown":n<this.history.length&&(n+=1,t.innerText=n===this.history.length?"":this.history[n]);break;case"Escape":t.innerText="";break;case"Enter":let e=t.innerText;t.replaceWith(CommandLineInterpreter.createElement("span.input",e+"\n")),/\w/.test(e)&&(n=this.history[this.history.length-1]!==e?this.history.push(e.trim()):this.history.length,this.memorize("history",this.history)),this.eval(e.trim()).finally((()=>{this.receiveInput(this.prompt,i)}))}};if(this.prompt=r.prompt||"\nCLI> ",this.options={richtextEnabled:r.richtextEnabled??!0,tabString:" ".repeat(r.tabWidth||2)},this.id=r?.id||this.constructor.name,"custom"!==r.theme&&document.head.append(CommandLineInterpreter.createElement(`link[rel="stylesheet"][href="https://chzager.github.io/cli/themes/${r.theme||"default"}.css"]`)),this.history=[],this.variables=new Map,localStorage){let e=JSON.parse(localStorage.getItem(this.id)||"{}");this.history=e?.history??[],Object.entries(e?.variables??{}).map((([e,t])=>this.variables.set(e,t)))}let n=this.history.length;this.commands=new Map;for(let t of[CommandLineInterpreter.builtInCommands,e])for(let[e,r]of Object.entries(t))"function"==typeof r&&this.commands.set(e,r);document.head.appendChild(CommandLineInterpreter.createElement("style",`#${this.constructor.name} * {${["background-color: transparent;","color: inherit;","font-family: inherit;","font-size: inherit;","padding: 0;","margin: 0;","border: none;","outline: none;","white-space: inherit;"].join("")}}`)),this.body=CommandLineInterpreter.createElement("div"),this.body.id=this.constructor.name,this.body.onclick=()=>{if(""===window.getSelection()?.toString()){let e=this.body.querySelector('.input[contenteditable="true"]');e instanceof HTMLElement&&e.focus()}},this.body.style.padding=r.padding||"0.75em",t instanceof HTMLElement||(t=document.body),t.appendChild(this.body),r?.motd&&this.writeLn(r.motd),this.eval(r?.startup??"").then((()=>{this.receiveInput(this.prompt,i)}))}eval(e){return new Promise((t=>{const r=e=>{this.writeLn(`[31m${e}`),console.error(e)},i=e=>new Promise((t=>{let i=!0,n=/^\s*(\S+)\s*=(.*)/.exec(e);if(n)if(/\W/.test(n[1]))this.writeLn(`Invalid token: ${/\W/.exec(n[1])?.[0]}`);else{let e=n[1],t=n[2].trim();t?this.variables.set(e,t):this.variables.delete(e),this.memorize("variables",Object.fromEntries(this.variables.entries()))}else{let n=/(\S+)(.*)/.exec(e);if(n){let e=n[1],a=this.commands.get(e);if("function"==typeof a){let e=[];for(let t of(n[2]??"").matchAll(/"([^"]*)"|\S+/g))e.push(t[1]||t[0]);e=e.map((e=>{if(!1===e.startsWith("-"))for(let t of e.matchAll(/\$(\w+)/g))e=e.replace(t[0],this.variables.get(t[1])??t[0]);return e}));try{let n=a(this,...e);n instanceof Promise&&(i=!1,n.catch(r).finally(t))}catch(e){r(e)}}else this.writeLn(`Unknown command: ${e}`)}}i&&t()})),n=()=>{let e=a.shift();e?i(e).finally(n):t()};let a=e.split(/\s*[;\n]+\s*/).filter((e=>!!e.trim()));n()}))}receiveInput(e,t){this.write(e);let r=CommandLineInterpreter.createElement('span.input[contenteditable="true"][spellcheck="false"][autocorrect="off"][autocapitalize="none"]');r.onkeydown=e=>{e.stopImmediatePropagation(),t(e)},setTimeout((()=>{this.body.appendChild(r),this.body.scrollTo(0,this.body.scrollHeight),r.focus()}),10)}memorize(e,t){if(localStorage){let r=JSON.parse(localStorage.getItem(this.id)||"{}");r[e]=t,localStorage.setItem(this.id,JSON.stringify(r))}}write(e){const t=e=>{let r=[],i=/((\*{1,2}|_{1,2}|`)([^\*\s].*?)\2)|((http)s?:\/\/\S+\b)|((\x1b\[)(3[0-7]|0)m(.+))/g;for(let n of e.matchAll(i)){let i,a,s=n[2]??n[5]??n[7],o=n[3]??n[4]??n[9],l=e.indexOf(o),c=o.length;if("["===s){let e="--cli-color-foreground";switch(n[8]){case"30":e="--cli-color-black";break;case"31":e="--cli-color-red";break;case"32":e="--cli-color-green";break;case"33":e="--cli-color-yellow";break;case"34":e="--cli-color-blue";break;case"35":e="--cli-color-magenta";break;case"36":e="--cli-color-cyan";break;case"37":e="--cli-color-white";break}i=`span[style="color:var(${e}"]`,a=t(o);let r=n[8].length+3;l-=r,c+=r}else if("http"===s)i=`a[href="${o}"][target="_blank"]`,a=[o];else{switch(s){case"**":case"__":i="b",a=t(o);break;case"*":case"_":i="i",a=t(o);break;case"`":i="code",a=[o];break}l-=s.length,c+=2*s.length}r.push(e.substring(0,l),CommandLineInterpreter.createElement(i,...a)),e=e.substring(l+c)}return r.push(e),r},r=e=>CommandLineInterpreter.createElement("table",...e.split("\n").map((e=>CommandLineInterpreter.createElement("tr",...e.split("\t").map((e=>{let r=CommandLineInterpreter.createElement("td",...t(e+this.options.tabString));return/^[\-\+]?\d+(\.\d*)?\s*$/.test(r.innerText)&&(r.style="text-align: right"),r}))))));return this.options.richtextEnabled?/\t/.test(e)?this.body.append(r(e.replace(/[\s\n]*$/g,""))):this.body.append(...t(e)):this.body.append(e.replace(/\x1b\[\d+m/g,"")),this.body.scrollTo(0,this.body.scrollHeight),this}writeLn(e){return this.write(e+"\n")}readKey(e,t){return new Promise((r=>{let i=[...e.map((e=>e.toLowerCase()))];this.receiveInput(t||e.join("/").toUpperCase()+"? ",(e=>{if(!1===/^f\d/i.test(e.key)&&(e.preventDefault(),i.includes(e.key.toLowerCase()))){let t=e.key;e.target.replaceWith(CommandLineInterpreter.createElement("span",t+"\n")),r(t.toUpperCase())}}))}))}readLn(e){return new Promise((t=>{this.receiveInput(e||"> ",(e=>{let r=e.target;switch(e.key){case"Escape":r.innerText="";break;case"Enter":r.replaceWith(CommandLineInterpreter.createElement("span.input",r.innerText+"\n")),t(r.innerText)}}))}))}readSecret(e){return new Promise((t=>{let r="";this.receiveInput(e||"> ",(e=>{switch(e.key){case"Enter":e.target.replaceWith(CommandLineInterpreter.createElement("span","\n")),t(r);break;case"Backspace":r=r.substring(0,r.length-1);break;default:1===e.key.length&&(e.preventDefault(),r+=e.key)}}))}))}static createElement(e,...t){let r=document.createElement(/^[a-z0-1]+/.exec(e)?.[0]||"div");for(let t of e.matchAll(/\[(.+?)=["'](.+?)["']\]/g))r.setAttribute(t[1],t[2]);for(let t of e.replaceAll(/\[.+\]/g,"").matchAll(/\.([^.[\s]+)/g))r.classList.add(t[1]);return r.append(...t),r}}